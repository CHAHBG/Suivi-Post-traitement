<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Communes — KPI</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Minimal page-specific tweaks to keep design coherent */
    .communes-page { max-width: 1200px; margin: 28px auto; padding: 20px; }
    .communes-header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px; }
    .communes-title { font-size:1.5rem; font-weight:700; color:var(--color-gray-900); }
    .controls-row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .table-wrap { background:var(--color-white); border-radius:12px; padding:12px; box-shadow:var(--shadow-sm); }
  /* Geomaticien modal styles */
  .geomaticien-modal { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:1200; }
  /* When modal host is hidden, ensure it's removed from layout and doesn't block pointer events */
  .geomaticien-modal[hidden] { display:none !important; pointer-events:none !important; }
  .geomaticien-modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.45); }
  .geomaticien-backdrop-anim { animation: geomaticienBackdrop .18s ease-out both; }
  @keyframes geomaticienBackdrop { from { opacity:0 } to { opacity:1 } }
  .geomaticien-contacts { display:flex; flex-direction:column; gap:8px; margin-top:8px }
  .contact-item { display:inline-flex; align-items:center; gap:10px; padding:8px 12px; border-radius:999px; background:linear-gradient(90deg,#fbfbff,#f4f3ff); border:1px solid rgba(99,102,241,0.06); font-weight:600 }
  .contact-icon { font-size:1.05rem; }
  /* Outer close button styling */
  #geomaticienClose { position:fixed; right:18px; top:18px; z-index:1300; display:none; padding:10px 12px; border-radius:10px; }
  /* remove any inner close button default appearance if present */
  .geomaticien-modal-panel button[aria-label="Fermer"]{ display:none }
  .geomaticien-link { display:inline-block; color:inherit; cursor:pointer; }
  .geomaticien-modal-panel { position:relative; background:var(--color-white); padding:18px; border-radius:12px; width:320px; max-width:92%; box-shadow:0 20px 40px rgba(0,0,0,0.25); transform:translateY(0); display:flex; flex-direction:column; align-items:center; text-align:center; gap:10px; }
  .geomaticien-floating { width:auto; max-width:80vw; }
  .geomaticien-card { display:flex; flex-direction:column; gap:8px; align-items:center; text-align:center; padding-top:8px }
  .geomaticien-avatar { width:128px; height:128px; border-radius:50%; background:#e9eafc; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:32px; color:#4f46e5; box-shadow:0 12px 26px rgba(79,70,229,0.22); border:6px solid rgba(99,102,241,0.12); overflow:hidden; margin:0 auto; }
  .geomaticien-avatar img{ width:100%; height:100%; object-fit:cover; object-position:center; display:block; border-radius:50% }
  .geomaticien-modal-panel .geomaticien-card h3{ margin:6px 0 0 0; font-size:1.15rem }
  .geomaticien-modal-panel .geomaticien-contacts{ width:100%; text-align:center }
  /* Animations */
  .geomaticien-fade-in { animation: geomaticienFade .18s ease-out both; }
  .geomaticien-avatar.anim { animation: geomaticienAvatarIn .26s cubic-bezier(.2,.9,.2,1) both; }
  @keyframes geomaticienFade { from { opacity:0; transform: translateY(6px) scale(.995); } to { opacity:1; transform: translateY(0) scale(1); } }
  @keyframes geomaticienAvatarIn { from { opacity:0; transform: translateY(-6px) scale(.95); } to { opacity:1; transform: translateY(0) scale(1); } }
  .geomaticien-contacts { margin-top:8px; font-size:0.95rem; }
  .geomaticien-modal [hidden] { display:none !important; }
  body.geomaticien-modal-open { overflow:hidden; }
    table.commune-table { width:100%; border-collapse:collapse; font-size:0.95rem; }
    table.commune-table thead th { text-align:left; padding:10px 8px; border-bottom:1px solid var(--color-gray-200); background:transparent; font-weight:600; }
    table.commune-table tbody td { padding:10px 8px; border-bottom:1px solid #f3f4f6; color:var(--color-gray-700); }
    table.commune-table tbody tr:hover { background: linear-gradient(90deg, rgba(99,102,241,0.03), transparent); }
    .small { font-size:0.85rem; color:var(--color-gray-500); }
    .btn { padding:8px 12px; border-radius:8px; background:var(--color-primary); color:white; border:none; cursor:pointer; }
    .btn-ghost { background:transparent; border:1px solid var(--color-gray-200); color:var(--color-gray-700); }
    .controls-row .filter-select, .controls-row .search-input { padding:8px 10px; border-radius:8px; border:1px solid var(--color-gray-200); }
    @media (max-width:900px){ .communes-header{flex-direction:column; align-items:stretch} }
  </style>
</head>
<body class="font-inter">
  <div class="communes-page">
    <div class="communes-header">
      <div>
        <div class="communes-title">KPIs par Commune</div>
        <div class="small">Données issues de la feuille <strong>Commune Status</strong> (dernier refresh automatique)</div>
      </div>
      <div class="controls-row" role="search" aria-label="Filtres des communes">
        <label for="regionFilter" class="visually-hidden">Filtrer par région</label>
        <select id="regionFilter" class="filter-select" aria-label="Filtrer par région">
          <option value="all">Toutes régions</option>
        </select>

        <label for="searchInput" class="visually-hidden">Rechercher commune ou géomaticien</label>
        <input id="searchInput" class="search-input" placeholder="Rechercher commune ou géomaticien..." aria-label="Rechercher commune ou géomaticien" />

        <label for="searchGeom" class="visually-hidden">Rechercher géomaticien</label>
        <input id="searchGeom" class="search-input" placeholder="Rechercher géomaticien..." style="display:none" aria-label="Rechercher géomaticien" />
        <select id="sortBy" class="filter-select" title="Trier par">
          <option value="name">Nom</option>
          <option value="total-desc">Total (haut→bas)</option>
          <option value="total-asc">Total (bas→haut)</option>
          <option value="nicad-desc">NICAD (haut→bas)</option>
        </select>
        <select id="pageSize" class="filter-select" title="Taille page">
          <option value="6">6 / page</option>
          <option value="9">9 / page</option>
          <option value="12" selected>12 / page</option>
        </select>
        <button id="exportFiltered" class="btn">Exporter (filtré)</button>
        <button id="exportAll" class="btn btn-ghost">Exporter (tous)</button>
        <button id="compactToggle" class="btn btn-ghost" title="Mode compact">Compact</button>
        <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="ctasfOnly"/>CTASF &gt; 0</label>
        <a href="index.html#commune-table" class="btn btn-ghost">Retour dashboard</a>
      </div>

      <!-- Floating action button for mobile quick actions (rendered visually via CSS) -->
      <div id="fabContainer">
        <button id="fabRefresh" class="fab-refresh" title="Actualiser" aria-label="Actualiser">⟳</button>
      </div>
    </div>

    <!-- Top summary removed per request (cards now carry per-commune KPIs) -->

    <div class="table-wrap">
      <div class="region-legend" id="regionLegend" style="display:flex;gap:10px;align-items:center;margin-bottom:12px"></div>
      <!-- Card grid for KPI cards -->
  <div class="communes-grid" id="communesGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:20px"></div>
        <!-- Contact modal for geomaticiens -->
        <div id="geomaticienModal" role="dialog" aria-modal="true" aria-labelledby="geomaticienModalTitle" class="geomaticien-modal" hidden>
          <div class="geomaticien-modal-backdrop" id="geomaticienBackdrop"></div>
          <!-- Modal panel content is created dynamically when opening to keep DOM clean until needed -->
          <button id="geomaticienClose" class="btn btn-ghost" aria-label="Fermer" style="display:none">✕</button>
          <div id="geomaticienModalContent" aria-hidden="true"></div>
        </div>
    </div>
  </div>

  <script src="js/communes.js" defer></script>
  <script>
    // If landing on index with #commune-table, ensure the dashboard activates that tab.
    // This small helper also helps when users return from the communes page using the anchor above.
    if(typeof window !== 'undefined'){
      const activateHashTab = () => {
        try{
          const hash = location.hash.replace('#','');
          if(!hash) return;
          // Defer to parent index's dashboard tab handler if available
          if(window.opener && window.opener.document){
            const btn = window.opener.document.querySelector(`.nav-tab[data-tab="${hash}"]`);
            if(btn) btn.click();
          }
        }catch(e){/* silent */}
      };
      // If this page was opened via target=_blank or similar, attempt activation on opener when unloading.
      window.addEventListener('beforeunload', activateHashTab);
    }
  </script>
  <script>
    // FAB refresh wiring: try to call fetchData from communes.js if present, otherwise dispatch a custom event
    document.addEventListener('DOMContentLoaded', function(){
      const fab = document.getElementById('fabRefresh');
      if(!fab) return;
      fab.addEventListener('click', function(){
        if(window.fetchData && typeof window.fetchData === 'function'){
          try{ window.fetchData(); }
          catch(e){ window.dispatchEvent(new CustomEvent('data:refresh')); }
        } else {
          window.dispatchEvent(new CustomEvent('data:refresh'));
        }
      });
    });
  </script>
</body>
</html>
