<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="Suivi Op√©rations Fonci√®re Boundou - Tableau de bord pour le suivi des op√©rations fonci√®res du Groupement d'Entreprises BET-PLUS & AUDET">
    <meta name="theme-color" content="#3B82F6">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Suivi Op√©rations Fonci√®re Boundou | BETPLUSAUDETAG</title>
    <!-- Prevent aggressive caching; favours fresh data on reload/reopen -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üó∫Ô∏è</text></svg>">

    <!-- Preconnect to external domains for faster loading -->
    <link rel="preconnect" href="https://docs.google.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="https://doc-0o-0g-sheets.googleusercontent.com">

    <!-- CSS Libraries -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Performance & accessibility: font preconnect and manifest -->
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="manifest" href="/manifest.webmanifest">
    <meta name="theme-color" content="#4f46e5">
    <!-- Content Security Policy (meta fallback) - server headers take precedence -->
    <!-- Note: 'unsafe-eval' removed to prevent eval() injection attacks -->
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://cdn.sheetjs.com https://www.googletagmanager.com 'unsafe-inline'; style-src 'self' https://cdnjs.cloudflare.com https://fonts.googleapis.com 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://docs.google.com https://sheets.googleapis.com https://*.google.com https://*.googleusercontent.com https://www.google-analytics.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://cdn.sheetjs.com https://fonts.googleapis.com https://fonts.gstatic.com; font-src 'self' https://cdnjs.cloudflare.com https://fonts.gstatic.com https://fonts.googleapis.com data:; frame-ancestors *; base-uri 'self'; form-action 'self';">

    <!-- JavaScript Libraries (defer to avoid blocking HTML parsing; order is preserved) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"
        defer></script>
    <!-- SheetJS for XLSX export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js" defer></script>

    <!-- Custom Styles -->
    <link rel="stylesheet" href="styles.css?v=3.0">
    <link rel="stylesheet" href="css/tubeProgress.css">
    <link rel="stylesheet" href="css/charts.css">
    <link rel="stylesheet" href="css/guidedTour.css">
    <!-- Data refresher: periodically fetch configured sheet endpoints -->
    <script src="js/analytics.js" defer></script>
    <script src="js/dataRefresher.js" defer></script>
    <script src="js/accessibilityHelpers.js" defer></script>

    <!-- Core app scripts (start downloading early; execute after parse in order) -->
    <script src="js/securityUtils.js?v=1.0" defer></script>
    <script src="js/performanceOptimizer.js?v=1.0" defer></script>
    <script src="js/localization.js?v=3.1" defer></script>
    <script src="js/config.js?v=3.2" defer></script>
    <script src="js/dataService.js?v=3.1" defer></script>
    <script src="js/chartService.js?v=3.2" defer></script>
    <script src="js/enhancedGoogleSheetsService.js?v=3.2" defer></script>
    <script src="js/dataAggregation.js?v=3.2" defer></script>
    <script src="js/dateParsingLoader.js?v=3.1" defer></script>
    <script src="js/statCardService.js?v=3.1" defer></script>
    <script src="js/forecastCard.js?v=3.1" defer></script>
    <script src="js/debugPanel.js?v=3.1" defer></script>
    <script src="js/enhancedDashboard.js?v=3.1" defer></script>
    <script src="js/streamingUpdates.js?v=3.1" defer></script>
    <script src="js/yieldsDateFix.js?v=3.1" defer></script>
    <script src="js/chronogramContent.js?v=3.1" defer></script>
    <script src="js/chronogramData.js?v=3.1" defer></script>
    <script src="js/chronogramIntegration.js?v=3.1" defer></script>
    <script src="js/guidedTour.js?v=3.1" defer></script>
    <script src="js/deliverablesService.js?v=3.9" defer></script>
    <script src="js/deliverablesPanel.js?v=3.3" defer></script>
</head>

<body class="font-inter antialiased" data-theme="light">
    <!-- Navigation Header -->
    <nav class="border-b border-subtle bg-surface z-50 sticky top-0" role="navigation" aria-label="En-t√™te">
        <div class="max-w-8xl mx-auto px-6 h-16 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <img src="assets/logo-betplus-audet.png" alt="BET-PLUS & AUDET Logo" class="h-12 w-12 object-contain">
                <div>
                    <h1 class="text-lg font-bold tracking-tight">Suivi Op√©rations Fonci√®re Boundou</h1>
                    <p class="text-xs text-secondary font-medium uppercase tracking-wider">BETPLUSAUDETAG</p>
                </div>
            </div>

            <div class="flex items-center space-x-4">
                <div class="hidden md:flex items-center space-x-6 border-r border-subtle pr-6 mr-2">
                    <div class="stat-pill flex flex-col">
                        <span class="stat-label text-[10px] font-bold text-tertiary uppercase">Actif</span>
                        <span class="stat-value text-sm font-bold text-success">0</span>
                    </div>
                    <div class="stat-pill flex flex-col">
                        <span class="stat-label text-[10px] font-bold text-tertiary uppercase">En cours</span>
                        <span class="stat-value text-sm font-bold text-warning">0</span>
                    </div>
                </div>

                <button id="helpTourBtn" class="tour-help-btn" title="Visite guid√©e">
                    <i class="fas fa-question-circle"></i>
                    <span class="hidden md:inline">Aide</span>
                </button>

                <button id="themeToggle" class="p-2 text-secondary hover:text-primary transition-colors">
                    <i id="themeIcon" class="fas fa-moon"></i>
                </button>

                <button id="refreshBtn"
                    class="bg-primary hover:bg-primary-dark text-white px-4 py-1.5 rounded-md text-sm font-semibold transition-all">
                    <i class="fas fa-sync-alt mr-2 text-xs"></i> Actualiser
                </button>
            </div>
        </div>
    </nav>

    <!-- Global Utility Bar (Sticky) -->
    <div class="utility-bar sticky top-16 border-b border-subtle z-40">
        <div class="max-w-8xl mx-auto px-6 flex items-center justify-between">
            <nav class="flex space-x-1" role="tablist">
                <button class="nav-tab active" data-tab="overview" role="tab" aria-selected="true" id="tab-overview">Vue
                    d'ensemble</button>
                <button class="nav-tab" data-tab="performance" role="tab" aria-selected="false"
                    id="tab-performance">Analyse
                    Performance</button>
                <button class="nav-tab" data-tab="regional" role="tab" aria-selected="false" id="tab-regional">Analyse
                    R√©gionale</button>
                <button class="nav-tab" data-tab="temporal" role="tab" aria-selected="false" id="tab-temporal">Suivi
                    Temporel</button>
            </nav>

            <div class="flex items-center space-x-3">
                <select id="regionFilter"
                    class="border border-subtle rounded-md px-3 py-1.5 text-sm bg-surface focus:border-primary outline-none transition-colors">
                    <option value="">Toutes les r√©gions</option>
                    <option value="Tambacounda">Tambacounda</option>
                    <option value="Kedougou">Kedougou</option>
                </select>
                <select id="timeFilter"
                    class="border border-subtle rounded-md px-3 py-1.5 text-sm bg-surface focus:border-primary outline-none transition-colors">
                    <option value="daily">Quotidien</option>
                    <option value="weekly">Hebdomadaire</option>
                    <option value="monthly">Mensuel</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Main Dashboard Container -->
    <main id="mainContent" class="max-w-8xl mx-auto px-6 pb-20" role="main">
        <div id="siteNotifications" aria-live="polite" class="sr-only"></div>

        <!-- Tab Panels -->
        <div id="tabPanels">

            <!-- Overview Panel -->
            <div id="panel-overview" data-panel="overview" class="panel active" role="tabpanel">

                <!-- Bento Grid Layout -->
                <div class="bento-grid">

                    <!-- Indicateurs Cl√©s de Performance - AT THE TOP -->
                    <div class="col-span-12 bento-card">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h3 class="text-sm font-bold">Indicateurs Cl√©s de Performance</h3>
                                <p class="text-[10px] text-tertiary">M√©triques d'efficacit√© et de projection strat√©gique
                                </p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-6">
                            <!-- Taux de R√©ussite (FTR) -->
                            <div class="kpi-card text-center p-4 bg-gradient-to-br from-blue-50 to-white rounded-xl border border-blue-100 cursor-help"
                                data-tooltip="CALCUL: (Parcelles Valid√©es / Parcelles Brutes) √ó 100&#10;&#10;Ce pourcentage montre combien de parcelles sont valid√©es du premier coup sans retour. Plus ce taux est √©lev√©, meilleure est la qualit√© du travail terrain.">
                                <div
                                    class="w-10 h-10 mx-auto mb-3 bg-blue-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-check-double text-blue-600"></i>
                                </div>
                                <div id="ftrValue" class="text-2xl font-bold text-blue-600">--</div>
                                <div class="text-[11px] text-slate-600 font-semibold mt-1">Taux R√©ussite</div>
                                <div class="text-[9px] text-slate-400">Valid√©es du 1er coup</div>
                            </div>
                            <!-- Prochain Lot -->
                            <div class="kpi-card text-center p-4 bg-gradient-to-br from-amber-50 to-white rounded-xl border border-amber-100 cursor-help"
                                data-tooltip="CALCUL: Somme des lev√©es du lundi au samedi de la semaine en cours&#10;&#10;Nombre de parcelles environ √† transmettre pour le prochain lot. Ce compteur se remet √† 0 chaque lundi et accumule les lev√©es jusqu'au samedi.">
                                <div
                                    class="w-10 h-10 mx-auto mb-3 bg-amber-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-clock text-amber-600"></i>
                                </div>
                                <div id="avgCycleTime" class="text-2xl font-bold text-amber-600">--</div>
                                <div class="text-[11px] text-slate-600 font-semibold mt-1">Prochain Lot</div>
                                <div class="text-[9px] text-slate-400">Parcelles √† transmettre</div>
                            </div>
                            <!-- Pertes (parcelles perdues) -->
                            <div class="kpi-card text-center p-4 bg-gradient-to-br from-red-50 to-white rounded-xl border border-red-100 cursor-help"
                                data-tooltip="CALCUL: Somme des (Parcelles Brutes - Parcelles Valid√©es) pour les entr√©es datant de plus de 48 heures&#10;&#10;Nombre de parcelles perdues √† cause de superpositions g√©om√©triques ou autres probl√®mes techniques. Ces parcelles ne peuvent pas √™tre trait√©es et repr√©sentent des pertes.">
                                <div
                                    class="w-10 h-10 mx-auto mb-3 bg-red-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-exclamation-triangle text-red-600"></i>
                                </div>
                                <div id="wipAge" class="text-2xl font-bold text-red-600">--</div>
                                <div class="text-[11px] text-slate-600 font-semibold mt-1">Pertes</div>
                                <div class="text-[9px] text-slate-400">Parcelles Perdues</div>
                            </div>
                            <!-- Fin Objectif Mensuel (Replacing Cadence Requise) -->
                            <div class="kpi-card text-center p-4 bg-gradient-to-br from-indigo-50 to-white rounded-xl border border-indigo-100 cursor-help"
                                data-tooltip="CALCUL: Date Actuelle + (Parcelles Mensuelles Restantes / Rythme Quotidien Moyen du Mois)&#10;&#10;Date estim√©e √† laquelle l'objectif mensuel sera atteint si le rythme actuel est maintenu.">
                                <div
                                    class="w-10 h-10 mx-auto mb-3 bg-indigo-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-calendar-check text-indigo-600"></i>
                                </div>
                                <div id="rrrValue" class="text-xl font-bold text-indigo-600">--</div>
                                <div class="text-[11px] text-slate-600 font-semibold mt-1">Fin Objectif</div>
                                <div class="text-[9px] text-slate-400">Rythme Actuel</div>
                            </div>
                            <!-- √âcart vs Objectif -->
                            <div class="kpi-card text-center p-4 bg-gradient-to-br from-purple-50 to-white rounded-xl border border-purple-100 cursor-help"
                                data-tooltip="CALCUL: Total R√©alis√© - (Objectif Journalier √ó Nombre de Jours Travaill√©s)&#10;&#10;Diff√©rence entre ce qui a √©t√© fait et ce qui aurait d√ª √™tre fait. Positif (+) = en avance, N√©gatif (-) = en retard.">
                                <div
                                    class="w-10 h-10 mx-auto mb-3 bg-purple-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-balance-scale text-purple-600"></i>
                                </div>
                                <div id="scheduleVariance" class="text-2xl font-bold text-purple-600">--</div>
                                <div class="text-[11px] text-slate-600 font-semibold mt-1">√âcart Cumul√©</div>
                                <div class="text-[9px] text-slate-400">vs Objectif</div>
                            </div>
                            <!-- Objectif 75k (Post-traitement) -->
                            <div class="kpi-card text-center p-4 bg-gradient-to-br from-emerald-50 to-white rounded-xl border border-emerald-100 cursor-help"
                                data-tooltip="CALCUL: Date Actuelle + (75,000 - Total Post-trait√©) / Cadence Journali√®re&#10;&#10;Formule: Temps = Travail Restant √∑ Rythme Actuel&#10;&#10;Date estim√©e pour atteindre 75,000 parcelles post-trait√©es bas√©es sur le rythme hebdomadaire actuel.">
                                <div
                                    class="w-10 h-10 mx-auto mb-3 bg-emerald-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-flag-checkered text-emerald-600"></i>
                                </div>
                                <div id="completionConfidence" class="text-xl font-bold text-emerald-600">--</div>
                                <div class="text-[11px] text-slate-600 font-semibold mt-1">Objectif 75k</div>
                                <div class="text-[9px] text-slate-400">Parcelles Post-trait√©es</div>
                            </div>
                        </div>

                        <!-- Deliverables KPIs Row 2 -->
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-4 gap-4 mt-4">
                            <!-- Livrables Valid√©s -->
                            <div class="kpi-card text-center p-4 bg-gradient-to-br from-green-50 to-white rounded-xl border border-green-100 cursor-help"
                                data-tooltip="Nombre total de livrables valid√©s par rapport au total de 68 livrables du projet.">
                                <div
                                    class="w-10 h-10 mx-auto mb-3 bg-green-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-check-circle text-green-600"></i>
                                </div>
                                <div id="livrablesValides" class="text-2xl font-bold text-green-600">--</div>
                                <div class="text-[11px] text-slate-600 font-semibold mt-1">Livrables Valid√©s</div>
                                <div class="text-[9px] text-slate-400">Sur 68 livrables</div>
                            </div>
                            <!-- En Examen -->
                            <div class="kpi-card text-center p-4 bg-gradient-to-br from-blue-50 to-white rounded-xl border border-blue-100 cursor-help"
                                data-tooltip="Nombre de livrables actuellement en cours de validation.">
                                <div
                                    class="w-10 h-10 mx-auto mb-3 bg-blue-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-clipboard-list text-blue-600"></i>
                                </div>
                                <div id="livrablesEnExamen" class="text-2xl font-bold text-blue-600">--</div>
                                <div class="text-[11px] text-slate-600 font-semibold mt-1">En Examen</div>
                                <div class="text-[9px] text-slate-400">En cours de validation</div>
                            </div>
                            <!-- En Retard (with pulse animation) -->
                            <div class="kpi-card text-center p-4 bg-gradient-to-br from-red-50 to-white rounded-xl border border-red-100 cursor-help relative"
                                data-tooltip="Nombre de livrables en retard n√©cessitant une attention imm√©diate.">
                                <div class="absolute top-2 right-2 w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                                <div
                                    class="w-10 h-10 mx-auto mb-3 bg-red-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-exclamation-triangle text-red-600"></i>
                                </div>
                                <div id="livrablesEnRetard" class="text-2xl font-bold text-red-600">--</div>
                                <div class="text-[11px] text-slate-600 font-semibold mt-1">En Retard</div>
                                <div class="text-[9px] text-slate-400">N√©cessite attention</div>
                            </div>
                            <!-- √Ä Venir -->
                            <div class="kpi-card text-center p-4 bg-gradient-to-br from-gray-50 to-white rounded-xl border border-gray-100 cursor-help"
                                data-tooltip="Nombre de livrables avec √©ch√©ances futures.">
                                <div
                                    class="w-10 h-10 mx-auto mb-3 bg-gray-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-calendar-alt text-gray-600"></i>
                                </div>
                                <div id="livrablesAVenir" class="text-2xl font-bold text-gray-600">--</div>
                                <div class="text-[11px] text-slate-600 font-semibold mt-1">√Ä Venir</div>
                                <div class="text-[9px] text-slate-400">√âch√©ances futures</div>
                            </div>

                        </div>
                    </div>

                    <!-- KPI Stat Cards (formerly Tubes) -->
                    <div class="col-span-12 lg:col-span-3 grid grid-cols-1 gap-4">
                        <div id="dailyStat" class="bento-card flex flex-col justify-between">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center justify-between mb-1">
                                        <h3 class="text-[10px] font-bold text-tertiary uppercase tracking-wider">
                                            Performance
                                            Jour
                                            <span id="dailyDateLabel"
                                                class="normal-case font-medium ml-1 text-slate-400"></span>
                                        </h3>
                                        <div id="dailyBadge" class="stat-card-badge"></div>
                                    </div>
                                    <div class="flex items-baseline space-x-2">
                                        <span id="dailyValue" class="text-2xl font-bold">0</span>
                                        <span id="dailyDelta" class="text-[10px] font-bold"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="stat-card-progress-wrapper">
                                <div class="stat-card-progress-bar">
                                    <div id="dailyProgressFill" class="stat-card-progress-fill" style="width: 0%"></div>
                                </div>
                                <div class="stat-card-target-label">
                                    <span>Objectif: <span id="dailyTarget">387</span> parcelles</span>
                                    <span id="dailyPercent">0%</span>
                                </div>
                            </div>
                            <div class="mt-4 h-10 overflow-hidden" id="dailySparkline">
                                <canvas id="dailySparklineCanvas"></canvas>
                            </div>
                        </div>

                        <div id="weeklyStat" class="bento-card flex flex-col justify-between">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center justify-between mb-1">
                                        <h3 class="text-[10px] font-bold text-tertiary uppercase tracking-wider">
                                            Hebdomadaire
                                            <span id="weeklyDateLabel"
                                                class="normal-case font-medium ml-1 text-slate-400"></span>
                                        </h3>
                                        <div id="weeklyBadge" class="stat-card-badge"></div>
                                    </div>
                                    <div class="flex items-baseline space-x-2">
                                        <span id="weeklyValue" class="text-2xl font-bold">0</span>
                                        <span id="weeklyDelta" class="text-[10px] font-bold"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="stat-card-progress-wrapper">
                                <div class="stat-card-progress-bar">
                                    <div id="weeklyProgressFill" class="stat-card-progress-fill" style="width: 0%">
                                    </div>
                                </div>
                                <div class="stat-card-target-label">
                                    <span>Objectif: <span id="weeklyTarget">2 710</span> parcelles</span>
                                    <span id="weeklyPercent">0%</span>
                                </div>
                            </div>
                            <div class="mt-4 h-10 overflow-hidden" id="weeklySparkline">
                                <canvas id="weeklySparklineCanvas"></canvas>
                            </div>
                        </div>

                        <div id="monthlyStat" class="bento-card flex flex-col justify-between">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center justify-between mb-1">
                                        <h3 class="text-[10px] font-bold text-tertiary uppercase tracking-wider">
                                            Objectif
                                            Mensuel
                                            <span id="monthlyDateLabel"
                                                class="normal-case font-medium ml-1 text-slate-400"></span>
                                        </h3>
                                        <div id="monthlyBadge" class="stat-card-badge"></div>
                                    </div>
                                    <div class="flex items-baseline space-x-2">
                                        <span id="monthlyValue" class="text-2xl font-bold">0</span>
                                        <span id="monthlyDelta" class="text-[10px] font-bold"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="stat-card-progress-wrapper">
                                <div class="stat-card-progress-bar">
                                    <div id="monthlyProgressFill" class="stat-card-progress-fill" style="width: 0%">
                                    </div>
                                </div>
                                <div class="stat-card-target-label">
                                    <span>Objectif: <span id="monthlyTarget">12 000</span> parcelles</span>
                                    <span id="monthlyPercent">0%</span>
                                </div>
                            </div>
                            <div class="mt-4 h-10 overflow-hidden" id="monthlySparkline">
                                <canvas id="monthlySparklineCanvas"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Main Chart: Daily Evolution -->
                    <div class="col-span-12 lg:col-span-9 bento-card">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h3 class="text-sm font-bold">√âVOLUTION QUOTIDIENNE DES LEV√âES</h3>
                                <p class="text-[11px] text-tertiary font-medium">Performance journali√®re vs Objectifs de
                                    production</p>
                            </div>
                            <div class="flex space-x-2">
                                <span
                                    class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold bg-primary-soft text-primary border border-primary/10">Saison
                                    2026</span>
                            </div>
                        </div>
                        <div class="chart-container" style="height: 380px; width: 100%;">
                            <canvas id="overviewDailyYieldsChart"></canvas>
                        </div>
                    </div>

                    <!-- Forecast & Secondary Metrics -->
                    <div class="col-span-12 lg:col-span-4 bento-card">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xs font-bold uppercase text-tertiary">Projection fin de mois</h3>
                            <i class="fas fa-magic text-primary text-xs"></i>
                        </div>
                        <div id="forecastContent" class="space-y-4">
                            <!-- Injected by forecastCard.js -->
                            <div class="animate-pulse flex space-x-4">
                                <div class="flex-1 space-y-4 py-1">
                                    <div class="h-4 bg-slate-200 rounded w-3/4"></div>
                                    <div class="space-y-2">
                                        <div class="h-4 bg-slate-200 rounded"></div>
                                        <div class="h-4 bg-slate-200 rounded w-5/6"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Status Overview -->
                    <div class="col-span-12 lg:col-span-8 bento-card">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xs font-bold uppercase text-tertiary">Statut du Pipeline</h3>
                            <div class="flex space-x-4 text-[10px] font-bold">
                                <div class="flex items-center"><span
                                        class="w-2 h-2 rounded-full bg-primary mr-2"></span>NICAD</div>
                                <div class="flex items-center"><span
                                        class="w-2 h-2 rounded-full bg-warning mr-2"></span>CTASF</div>
                                <div class="flex items-center"><span
                                        class="w-2 h-2 rounded-full bg-success mr-2"></span>D√©lib√©r√©es</div>
                            </div>
                        </div>
                        <div id="monitoringIndicators" class="grid grid-cols-1 md:grid-cols-3 gap-8">
                            <!-- Progress elements updated by dashboard logic -->
                            <div class="space-y-3">
                                <div class="flex justify-between text-[11px] font-bold">
                                    <span>NICAD</span>
                                    <span id="nicadOverviewValue">0</span>
                                </div>
                                <div class="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
                                    <div id="nicadOverviewProgress"
                                        class="h-full bg-primary transition-all duration-1000" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <div class="flex justify-between text-[11px] font-bold">
                                    <span>CTASF</span>
                                    <span id="ctasfOverviewValue">0</span>
                                </div>
                                <div class="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
                                    <div id="ctasfOverviewProgress"
                                        class="h-full bg-warning transition-all duration-1000" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <div class="flex justify-between text-[11px] font-bold">
                                    <span>D√âLIB√âR√âES</span>
                                    <span id="deliberatedOverviewValue">0</span>
                                </div>
                                <div class="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
                                    <div id="deliberatedOverviewProgress"
                                        class="h-full bg-success transition-all duration-1000" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Chronogramme quick action removed; navigation remains available in the Analyse R√©gionale panel -->

        </div>


        <!-- Performance Panel (NEW) -->
        <div id="panel-performance" data-panel="performance" class="panel" role="tabpanel" hidden>
            <div class="bento-grid">
                <!-- Burn-Up Chart -->
                <div class="col-span-12 lg:col-span-6 bento-card">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-sm font-bold">Graphique Burn-Up</h3>
                            <p class="text-[10px] text-tertiary">Progression cumulative vs Objectif</p>
                        </div>
                        <span class="info-tooltip"
                            title="Comment lire: La ligne bleue montre le cumul r√©alis√©. La ligne rouge pointill√©e est l'objectif lin√©aire. Si la ligne bleue est au-dessus de la rouge, vous √™tes en avance. La projection (pointill√©s bleus) indique la trajectoire future bas√©e sur la v√©locit√© actuelle."><i
                                class="fas fa-info-circle"></i></span>
                    </div>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="burnUpChart"></canvas>
                    </div>
                </div>

                <!-- Velocity Deviation Chart -->
                <div class="col-span-12 lg:col-span-6 bento-card">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-sm font-bold">√âcart de V√©locit√©</h3>
                            <p class="text-[10px] text-tertiary">Performance journali√®re vs objectif (0 = cible)</p>
                        </div>
                        <span class="info-tooltip"
                            title="Comment lire: Chaque barre repr√©sente un jour. Vert = au-dessus de l'objectif journalier, Rouge = en dessous. La ligne 0 est l'objectif. Plus la barre verte est haute, meilleure est la performance. Des barres rouges r√©p√©t√©es indiquent un retard √† rattraper."><i
                                class="fas fa-info-circle"></i></span>
                    </div>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="velocityDeviationChart"></canvas>
                    </div>
                </div>

                <!-- Status Aging Histogram -->
                <div class="col-span-12 lg:col-span-6 bento-card">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-sm font-bold">Anciennet√© du Backlog</h3>
                            <p class="text-[10px] text-tertiary">R√©partition par statut et dur√©e de traitement</p>
                        </div>
                        <span class="info-tooltip"
                            title="Comment lire: Les barres empil√©es montrent combien de parcelles sont dans chaque statut. Vert = r√©cent (&lt;1 jour), Orange = 2-5 jours, Rouge = plus de 5 jours. Beaucoup de rouge signifie des dossiers 'zombies' √† traiter en priorit√©."><i
                                class="fas fa-info-circle"></i></span>
                    </div>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="statusAgingChart"></canvas>
                    </div>
                    <div class="flex justify-center space-x-4 mt-3 text-[10px] font-bold">
                        <span class="flex items-center"><span
                                class="w-3 h-3 bg-emerald-500 mr-1.5 rounded"></span>R√©cent (&lt;1j)</span>
                        <span class="flex items-center"><span class="w-3 h-3 bg-amber-500 mr-1.5 rounded"></span>Moyen
                            (2-5j)</span>
                        <span class="flex items-center"><span class="w-3 h-3 bg-red-500 mr-1.5 rounded"></span>Ancien
                            (&gt;5j)</span>
                    </div>
                </div>

                <!-- Bullet Charts for Regional Comparison -->
                <div class="col-span-12 lg:col-span-6 bento-card">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-sm font-bold">Comparaison R√©gionale</h3>
                            <p class="text-[10px] text-tertiary">Bullet Charts - R√©alis√© vs Objectif par r√©gion</p>
                        </div>
                        <span class="info-tooltip"
                            title="Comment lire: Chaque r√©gion a une barre. La barre noire = r√©alis√© actuel. La ligne rouge verticale = objectif. Le fond color√© indique les zones: vert clair = bon, orange clair = moyen, rouge clair = insuffisant. Si la barre d√©passe la ligne rouge, l'objectif est atteint."><i
                                class="fas fa-info-circle"></i></span>
                    </div>
                    <div id="bulletChartsContainer" class="space-y-4">
                        <!-- Injected by JS -->
                    </div>
                </div>

                <!-- Deliverables Tracking Panel -->
                <div class="col-span-12 bento-card">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="text-sm font-bold">Suivi des Livrables</h3>
                            <p class="text-[11px] text-tertiary">Tableau de bord des 68 livrables du projet</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <!-- Search -->
                            <input type="text" id="delivrablesSearch" placeholder="Rechercher..."
                                class="text-xs px-3 py-1.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <!-- Filter buttons -->
                            <button
                                class="deliverables-filter-btn active text-xs px-3 py-1.5 rounded-lg font-semibold transition-colors"
                                data-status="all">
                                Tous (<span id="filter-count-all">68</span>)
                            </button>
                            <button
                                class="deliverables-filter-btn text-xs px-3 py-1.5 rounded-lg font-semibold transition-colors bg-green-50 text-green-700 hover:bg-green-100"
                                data-status="valid√©">
                                Valid√©s (<span id="filter-count-valide">29</span>)
                            </button>
                            <button
                                class="deliverables-filter-btn text-xs px-3 py-1.5 rounded-lg font-semibold transition-colors bg-blue-50 text-blue-700 hover:bg-blue-100"
                                data-status="en-examen">
                                En Examen (<span id="filter-count-examen">5</span>)
                            </button>
                            <button
                                class="deliverables-filter-btn text-xs px-3 py-1.5 rounded-lg font-semibold transition-colors bg-red-50 text-red-700 hover:bg-red-100"
                                data-status="retard">
                                En Retard (<span id="filter-count-retard">7</span>)
                            </button>
                            <button
                                class="deliverables-filter-btn text-xs px-3 py-1.5 rounded-lg font-semibold transition-colors bg-gray-50 text-gray-700 hover:bg-gray-100"
                                data-status="a-venir">
                                √Ä Venir (<span id="filter-count-avenir">20</span>)
                            </button>
                        </div>
                    </div>

                    <!-- Statistics Dashboard -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <!-- By Expert/Pool -->
                        <div class="bg-slate-50 rounded-lg p-4">
                            <h4 class="text-xs font-bold text-slate-700 mb-3">R√©partition par Expert</h4>
                            <div id="expertBreakdown" class="space-y-2 text-xs">
                                <!-- Injected by JS -->
                            </div>
                        </div>

                        <!-- Timeline Metrics -->
                        <div class="bg-slate-50 rounded-lg p-4">
                            <h4 class="text-xs font-bold text-slate-700 mb-3">M√©triques Temporelles</h4>
                            <div class="space-y-2 text-xs">
                                <div class="flex justify-between">
                                    <span class="text-slate-600">Valid√©s √† temps:</span>
                                    <span id="stat-valides-temps" class="font-semibold text-green-600">--</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-600">Valid√©s en retard:</span>
                                    <span id="stat-valides-retard" class="font-semibold text-orange-600">--</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-600">Retard moyen:</span>
                                    <span id="stat-retard-moyen" class="font-semibold text-slate-700">--</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-600">Plus grand retard:</span>
                                    <span id="stat-plus-grand-retard" class="font-semibold text-red-600">--</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Deliverables Table -->
                    <div class="overflow-x-auto">
                        <table id="deliverablesTable" class="w-full text-xs">
                            <thead class="bg-slate-100 sticky top-0">
                                <tr>
                                    <th class="px-3 py-2 text-left font-semibold text-slate-700 cursor-pointer hover:bg-slate-200"
                                        data-sort="index">
                                        Index <i class="fas fa-sort ml-1 text-slate-400"></i>
                                    </th>
                                    <th class="px-3 py-2 text-left font-semibold text-slate-700">Livrable</th>
                                    <th class="px-3 py-2 text-left font-semibold text-slate-700 cursor-pointer hover:bg-slate-200"
                                        data-sort="expert">
                                        Expert <i class="fas fa-sort ml-1 text-slate-400"></i>
                                    </th>
                                    <th class="px-3 py-2 text-left font-semibold text-slate-700 cursor-pointer hover:bg-slate-200"
                                        data-sort="date">
                                        √âch√©ance <i class="fas fa-sort ml-1 text-slate-400"></i>
                                    </th>
                                    <th class="px-3 py-2 text-left font-semibold text-slate-700">Statut</th>
                                    <th class="px-3 py-2 text-center font-semibold text-slate-700">Alerte</th>
                                </tr>
                            </thead>
                            <tbody id="deliverablesTableBody">
                                <!-- Injected by JS -->
                                <tr>
                                    <td colspan="6" class="px-3 py-8 text-center text-slate-500">
                                        <i class="fas fa-spinner fa-spin mr-2"></i>Chargement des livrables...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>


        <!-- Regional Panel -->
        <div id="panel-regional" data-panel="regional" class="panel" role="tabpanel" hidden>
            <div class="bento-grid">
                <!-- Dynamic per Region - Full Width -->
                <div class="col-span-12 bento-card">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="text-sm font-bold">Dynamique par R√©gion</h3>
                            <p class="text-[10px] text-tertiary">√âvolution des lev√©es par r√©gion au fil du temps</p>
                        </div>
                        <span class="info-tooltip"
                            title="Ce graphique montre l'√©volution quotidienne des lev√©es pour chaque r√©gion. Chaque ligne color√©e repr√©sente une r√©gion diff√©rente. Survolez pour voir les valeurs exactes."><i
                                class="fas fa-info-circle"></i></span>
                    </div>
                    <div class="chart-container" style="height: 350px;">
                        <canvas id="regionalTrendChart"></canvas>
                    </div>
                </div>

                <!-- Top Communes -->
                <div class="col-span-12 lg:col-span-6 bento-card">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="text-sm font-bold">Top 15 Communes</h3>
                            <p class="text-[10px] text-tertiary">Classement par volume de lev√©es</p>
                        </div>
                        <span class="info-tooltip"
                            title="Les 15 communes les plus productives class√©es par nombre total de lev√©es. Plus la barre est longue, plus la commune a produit de lev√©es."><i
                                class="fas fa-info-circle"></i></span>
                    </div>
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="communeComparisonChart"></canvas>
                    </div>
                </div>

                <!-- Team Productivity -->
                <div class="col-span-12 lg:col-span-6 bento-card">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="text-sm font-bold">Productivit√© par √âquipe</h3>
                            <p class="text-[10px] text-tertiary">R√©partition du travail entre √©quipes</p>
                        </div>
                        <span class="info-tooltip"
                            title="Comparaison de la production entre les √©quipes A et B. Permet d'identifier les d√©s√©quilibres de charge de travail."><i
                                class="fas fa-info-circle"></i></span>
                    </div>
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="teamProductivityChart"></canvas>
                    </div>
                </div>

            </div>
        </div>


        <!-- Temporal Panel -->
        <div id="panel-temporal" data-panel="temporal" class="panel" role="tabpanel" hidden>
            <div class="bento-grid">
                <!-- Daily Yields Evolution - Full Width -->
                <div class="col-span-12 bento-card">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-sm font-bold">√âvolution Quotidienne des Lev√©es</h3>
                            <p class="text-[10px] text-tertiary">Nombre de lev√©es par jour vs objectif journalier</p>
                        </div>
                        <span class="info-tooltip"
                            title="La ligne bleue montre les lev√©es r√©alis√©es chaque jour. La ligne rouge pointill√©e est l'objectif quotidien. Quand la ligne bleue est au-dessus, l'objectif du jour est atteint."><i
                                class="fas fa-info-circle"></i></span>
                    </div>
                    <div class="chart-container" style="height: 350px;">
                        <canvas id="dailyYieldsChart"></canvas>
                    </div>
                </div>

                <!-- Yields vs Validation Comparison -->
                <div class="col-span-12 lg:col-span-6 bento-card">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-sm font-bold">Lev√©es Terrain vs Parcelles Valid√©es</h3>
                            <p class="text-[10px] text-tertiary">Comparaison flux entrant vs flux trait√©</p>
                        </div>
                        <span class="info-tooltip"
                            title="Ligne bleue = lev√©es re√ßues du terrain. Ligne verte = parcelles valid√©es par le post-traitement. L'√©cart entre les deux montre le backlog √† traiter."><i
                                class="fas fa-info-circle"></i></span>
                    </div>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="yieldsVsValidationChart"></canvas>
                    </div>
                </div>

                <!-- Validation Rate Over Time -->
                <div class="col-span-12 lg:col-span-6 bento-card">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-sm font-bold">Taux de Validation Quotidien</h3>
                            <p class="text-[10px] text-tertiary">Pourcentage de parcelles valid√©es par jour</p>
                        </div>
                        <span class="info-tooltip"
                            title="Pourcentage de parcelles valid√©es par rapport aux parcelles brutes re√ßues. Un taux proche de 100% signifie que le post-traitement suit le rythme des lev√©es."><i
                                class="fas fa-info-circle"></i></span>
                    </div>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="validationRateChart"></canvas>
                    </div>
                </div>

                <!-- Quality Trend -->
                <div class="col-span-12 lg:col-span-6 bento-card">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-sm font-bold">Qualit√© de l'Affichage</h3>
                            <p class="text-[10px] text-tertiary">Taux de parcelles affich√©es sans erreur</p>
                        </div>
                        <span class="info-tooltip"
                            title="Pourcentage de parcelles affich√©es sans erreur. L'objectif est de maintenir ce taux au-dessus de 95% (ligne rouge)."><i
                                class="fas fa-info-circle"></i></span>
                    </div>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="qualityTrendChart"></canvas>
                    </div>
                </div>

                <!-- Post-Processing Chart -->
                <div class="col-span-12 lg:col-span-6 bento-card">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-sm font-bold">Flux Post-traitement</h3>
                            <p class="text-[10px] text-tertiary">Parcelles re√ßues vs parcelles valid√©es</p>
                        </div>
                        <span class="info-tooltip"
                            title="Ligne pointill√©e grise = parcelles brutes re√ßues. Ligne verte = parcelles valid√©es. L'aire verte repr√©sente le travail accompli."><i
                                class="fas fa-info-circle"></i></span>
                    </div>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="postProcessingChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        </div>

        <!-- Data Tables Section -->
        <section class="tables-section mt-16">
            <div class="section-intro mb-8">
                <h2 class="section-title">Donn√©es d√©taill√©es</h2>
                <div class="flex justify-between items-center gap-4">
                    <p class="section-description">Acc√®s aux donn√©es brutes et historiques</p>
                    <button class="action-button text-sm download-btn flex-shrink-0"
                        title="T√©l√©charger les donn√©es affich√©es">
                        <i class="fas fa-download mr-1"></i> XLSX
                    </button>
                </div>
            </div>

            <div class="table-container">
                <div class="table-tabs">
                    <button class="table-tab active" data-tab="yields">
                        <i class="fas fa-chart-bar"></i>
                        Lev√©es
                    </button>
                    <button class="table-tab" data-tab="display">
                        <i class="fas fa-eye"></i>
                        Affichage
                    </button>
                    <button class="table-tab" data-tab="ctasf">
                        <i class="fas fa-file-alt"></i>
                        CTASF
                    </button>
                    <button class="table-tab" data-tab="processing">
                        <i class="fas fa-cogs"></i>
                        Traitement
                    </button>
                </div>

                <div class="table-content">
                    <div id="yieldsTable" class="table-panel active">
                        <div class="table-wrapper">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>R√©gion</th>
                                        <th>Commune</th>
                                        <th>Nombre de Lev√©es</th>
                                        <th>Statut</th>
                                    </tr>
                                </thead>
                                <tbody id="yieldsTableBody">
                                    <!-- Data populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Public Display Follow-up Table -->
                    <div id="displayTable" class="table-panel">
                        <div class="table-wrapper">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>R√©gion</th>
                                        <th>Commune</th>
                                        <th>Sans erreurs</th>
                                        <th>Avec erreur</th>
                                        <th>Motif retour</th>
                                    </tr>
                                </thead>
                                <tbody id="displayTableBody">
                                    <!-- Data populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- CTASF Follow-up Table -->
                    <div id="ctasfTable" class="table-panel">
                        <div class="table-wrapper">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>R√©gion</th>
                                        <th>Commune</th>
                                        <th>Emmen√©es</th>
                                        <th>Retenues</th>
                                        <th>√Ä d√©lib√©rer</th>
                                        <th>D√©lib√©r√©es</th>
                                    </tr>
                                </thead>
                                <tbody id="ctasfTableBody">
                                    <!-- Data populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Post Process Follow-up Table -->
                    <div id="processingTable" class="table-panel">
                        <div class="table-wrapper">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Pr√©nom Topo</th>
                                        <th>Nom Topo</th>
                                        <th>Commune</th>
                                        <th>Zone</th>
                                        <th>Village</th>
                                        <th>Parcelles Brutes</th>
                                        <th>Parcelles Valid√©es</th>
                                        <th>Total √âquipe A</th>
                                        <th>Total √âquipe B</th>
                                        <th>G√©omaticien</th>
                                    </tr>
                                </thead>
                                <tbody id="processingTableBody">
                                    <!-- Data populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner">
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
            </div>
            <h3 class="loading-title" id="loadingMessage">Initialisation du dashboard</h3>
            <p class="loading-subtitle" id="loadingTimer">Chargement en cours...</p>
        </div>
    </div>

    <script>
        // Loading timer and overlay management
        let loadingSeconds = 0;
        const loadingTimer = setInterval(() => {
            loadingSeconds++;
            const timerElement = document.getElementById('loadingTimer');
            if (timerElement) {
                timerElement.textContent = `${loadingSeconds}s √©coul√©es`;
            }

            const messageElement = document.getElementById('loadingMessage');
            if (messageElement) {
                if (loadingSeconds > 3) {
                    messageElement.textContent = 'Pr√©paration des graphiques...';
                }
                if (loadingSeconds > 6) {
                    messageElement.textContent = 'Configuration des donn√©es...';
                }
                if (loadingSeconds > 9) {
                    messageElement.textContent = 'Finalisation...';
                }
            }

            if (loadingSeconds >= 15) {
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) overlay.style.display = 'none';
                clearInterval(loadingTimer);
            }
        }, 1000);

        function hideLoadingOverlay() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.classList.add('fade-out');
                setTimeout(() => {
                    loadingOverlay.style.display = 'none';
                    clearInterval(loadingTimer);
                }, 300);
            }
        }

        // Initialize dashboard
        window.dashboardInitialized = false;

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                setTimeout(hideLoadingOverlay, 5000);

                console.log('Initializing PROCASSEF Dashboard...');
                // With `defer` script loading, EnhancedDashboard should be ready by DOMContentLoaded.
                if (typeof EnhancedDashboard === 'undefined') {
                    console.error('EnhancedDashboard class not found! Check script loading order.');
                    return;
                }

                window.dashboard = new EnhancedDashboard();
                await window.dashboard.initialize();
                window.dashboardInitialized = true;
                console.log('Dashboard ready!');
                hideLoadingOverlay();
            } catch (error) {
                console.error('Error initializing dashboard:', error);
                hideLoadingOverlay();
            }
        });

        // Tab switching
        document.addEventListener('click', (e) => {
            const tab = e.target.closest('.nav-tab');
            if (tab) {
                const targetPanel = tab.dataset.tab;

                // Update tabs
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                // Update panels
                document.querySelectorAll('.panel').forEach(p => {
                    if (p.dataset.panel === targetPanel) {
                        p.classList.add('active');
                        p.removeAttribute('hidden');
                    } else {
                        p.classList.remove('active');
                        p.setAttribute('hidden', '');
                    }
                });

                // Trigger chart resize
                if (window.chartService && window.chartService._debouncedResize) {
                    window.chartService._debouncedResize();
                }
            }

            // Table tabs
            if (e.target.matches('.table-tab') || e.target.closest('.table-tab')) {
                const tab = e.target.closest('.table-tab');
                const targetTable = tab.dataset.tab;

                document.querySelectorAll('.table-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                document.querySelectorAll('.table-panel').forEach(p => {
                    if (p.id === targetTable + 'Table') {
                        p.classList.add('active');
                    } else {
                        p.classList.remove('active');
                    }
                });
            }
        });

        // Theme toggle
        document.getElementById('themeToggle')?.addEventListener('click', () => {
            const currentTheme = document.body.dataset.theme;
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            document.body.dataset.theme = newTheme;
            document.documentElement.classList.toggle('dark', newTheme === 'dark');

            const icon = document.getElementById('themeIcon');
            if (icon) icon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';

            localStorage.setItem('proc-theme', newTheme);

            // Notify ChartService to update chart colors
            if (window.chartService && typeof window.chartService.updateTheme === 'function') {
                window.chartService.updateTheme();
            }
        });

        // Initialize theme
        const savedTheme = localStorage.getItem('proc-theme') || 'light';

        document.body.dataset.theme = savedTheme;
        if (savedTheme === 'dark') {
            document.documentElement.classList.add('dark');
            document.getElementById('themeIcon').className = 'fas fa-sun';
        }
    </script>

    <script>
        // Help button to restart tour
        document.addEventListener('DOMContentLoaded', function () {
            const helpBtn = document.getElementById('helpTourBtn');
            if (helpBtn) {
                helpBtn.addEventListener('click', function () {
                    if (window.guidedTour) {
                        window.guidedTour.start();
                    }
                });
            }
        });
    </script>

    <script>
        // wire the "View All Communes" button to the new communes page
        document.addEventListener('DOMContentLoaded', function () {
            const btn = document.getElementById('viewAllCommunes');
            if (btn) btn.addEventListener('click', function (ev) { ev.preventDefault(); window.location.href = 'communes.html'; });
        });
    </script>

</body>

</html>